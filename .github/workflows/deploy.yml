name: Build & Deploy

on:
  push:
    branches: [main]
  repository_dispatch:
    types: [schema-updated]
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

env:
  ACR_NAME: crterprint
  ACR_LOGIN_SERVER: crterprint.azurecr.io
  IMAGE_NAME: cdes-mcp-server
  CONTAINER_APP: ca-cdes-mcp-server
  RESOURCE_GROUP: rg-dev-terprint-ca

jobs:
  # ------------------------------------------------------------------
  # Job 1 — Lint & Test
  # ------------------------------------------------------------------
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.12", "3.13"]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: pip install -e ".[dev]"

      - name: Lint
        run: |
          ruff check src/ tests/
          ruff format --check src/ tests/

      - name: Test
        run: pytest tests/ -v --tb=short

  # ------------------------------------------------------------------
  # Job 2 — Build Docker image & push to ACR
  # ------------------------------------------------------------------
  build:
    needs: test
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{ steps.meta.outputs.tag }}
    steps:
      - uses: actions/checkout@v4

      - name: Generate image tag
        id: meta
        run: |
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          TAG="dev-${SHORT_SHA}"
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "Image tag: ${TAG}"

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: ACR Login
        run: az acr login --name ${{ env.ACR_NAME }}

      - name: Build & Push
        run: |
          IMAGE="${{ env.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.tag }}"
          docker build -t "${IMAGE}" .
          docker push "${IMAGE}"
          echo "Pushed ${IMAGE}"

  # ------------------------------------------------------------------
  # Job 3 — Deploy to Azure Container Apps
  # ------------------------------------------------------------------
  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment: dev
    steps:
      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Deploy to Container App
        run: |
          IMAGE="${{ env.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ needs.build.outputs.image-tag }}"
          echo "Deploying ${IMAGE} to ${{ env.CONTAINER_APP }}"

          az containerapp update \
            --name ${{ env.CONTAINER_APP }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --image "${IMAGE}"

      - name: Verify deployment
        run: |
          sleep 15
          FQDN=$(az containerapp show \
            --name ${{ env.CONTAINER_APP }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query "properties.configuration.ingress.fqdn" -o tsv)
          echo "Checking health at https://${FQDN}/health"
          curl -sf "https://${FQDN}/health" | python3 -m json.tool
